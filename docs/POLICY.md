# 🔐 프로세스 보안 분석 규칙 (Process Analysis Policy)

> 이 문서는 프로세스 분석 & 보안 모니터링 기능의 판단 기준과 예외 정책을 정의한다.
> 본 문서는 process.py에 구현된 실무 로직을 바탕으로, 프로세스 분석 및 보안 모니터링 판단 기준을 정의한다.

## 분석 설계 원칙
### 1. 데이터 중심 분석
- 수집 단계에서 OS 정보를 확정하여 데이터 객체에 포함하며, 분석 단계는 외부 환경이 아닌 오직 전달된 데이터(Dict)만을 기반으로 판단
- 동일한 프로세스 데이터에 대해 동일한 분석 결과 보장

### 1. 위험 우선순위 (Risk Hierarchy)
- 권한(`username`), 네트워크(`ports`), 실행 경로(`exe`)를 최우선 위험 요소로 간주
- CPU/메모리 점유율은 시스템 장애 가능성을 시사하는 보조 지표로 활용

### 1. 화이트리스트 기반 예외 처리
- 시스템 필수 프로세스에 대한 오탐을 방지하기 위해 `KNOWN_PROCESSES` 및 `WINDOWS_SYSTEM_PROCS` 등의 화이트리스트 정책을 적용
  
---
<br>

## 위험 판단 기준 (Warning Rules)
### 1. RUNNING_AS_ROOT
- root, SYSTEM, Administrator 권한 실행
- Windows PID 4 제외
- 위험 레벨 : 🟠 주의

### 2. PUBLIC_PORT(n)
- KNOWN_PORTS에 정의된 주요 서비스 포트를 의도하지 않은 서비스가 점유하여 외부 접근을 허용하고 있는 경우
- 위험 레벨 : 🟡 정보 / 🟠 주의

### 3. SYSTEM_PORT(n)
- 비표준 시스템 포트 개방
- `port < 1024` (단, `KNOWN_PORTS` 및 `WINDOWS_SYSTEM_PORTS` 제외)
- 위험 레벨 : 🔴 위험

### 4. HIGH_MEMORY_USAGE
- 메모리 사용률 ≥ 20%
- 서비스 장애, 메모리 릭 가능성 점검 필요
- 위험 레벨 : 🟡 정보

### 5. SUSPICIOUS_PATH
- 표준 실행경로 외 위치에서 실행
- 악성코드 / 수동 배포 바이너리 탐지 목적
- 위험 레벨 : 🔴 위험

---
<br>

## Windows 전용 정책
### 1. 기본 시스템 프로세스 포트 예외
> Windows 핵심 서비스 프로세스가 정의된 시스템 포트를 사용하는 경우 정상으로 간주

#### 대상 프로세스 예시
```
svchost.exe
lsass.exe
services.exe
wininit.exe
winlogon.exe
```

#### 예외 포트 예시
```
135 (RPC)
137–139 (NetBIOS)
445 (SMB)
5357 (WS-Discovery)
```

#### 목적
- RPC/SMB 등 필수 서비스에 대한 오탐 제거
- "시스템 포트 = 무조건 위험" 판단 방지

---

### 2. 개발 도구(Dev Process) 정책
> 개발 도구도 보안 면책 대상이 아님 관리자 권한 실행, 외부 포트 개방 시 경고 유지

#### ❌ 과거
- 개발 도구 → 분석 전체 제외

#### ✅ 현재
- 개발 도구 → 경로 검사만 예외
- 권한 / 포트 / 자원 사용은 정상 분석

#### 대상 예시
```
code.exe (VS Code)
idea64.exe
pycharm64.exe
node.exe
```

---

### 3. Windows 보안 프로세스 오탐 방지
> 일부 Windows 보안/시스템 프로세스는 경로가 특이하지만 정상 동작

#### 예시
```
MsMpEng.exe (Windows Defender)
MpDefenderCoreService.exe (Windows Defender 핵심 보안 서비스)
MemCompression.exe (Windows 메모리 압축 관리 프로세스)
```

해당 프로세스는 WINDOWS_SYSTEM_PROCS 또는 KNOWN_PROCESSES에 포함하여 관리한다.

#### 효과
- 보안 솔루션을 “보안 위협”으로 오인하는 문제 제거
- 모니터링 신뢰도 유지

---
<br>

## Linux 전용 고려 사항

### 1. 표준 경로
- `/usr`, `/bin`, `/opt`를 표준 경로로 간주하며, 그 외 경로는 의심 사례로 분류
- `/var/lib`, `/tmp`는 환경에 따라 예외 가능
- 
### 2. 권한 제약
- root 권한 프로세스가 주 감시 대상
- 일반 사용자 계정으로 모니터링 도구 실행 시, 타 사용자의 포트 정보 수집에 제한이 있을 수 있으므로 관리자 권한(sudo) 실행을 권장

---
<br>

## 종합 진단 가이드

### 1. 진단 케이스 (Case A/B/C)
| 코드 | 조건                          | 판단         |
| --- | ----------------------------- | ---------- |
| `OK` | 등록된 프로세스(KNOWN)이면서 보안 경고가 0건인 경우 | ✅ 안전       |
| `WARN` | 보안 경고는 없으나, DB에 등록되지 않은 프로세스     | ⚠️ 미등록 프로세스      |
| `DANGER` | 보안 경고(warnings)가 1건이라도 존재하는 경우      | 🚨 SUSPICIOUS_PATH 외 n건 |

### 2. 정렬 및 출력 로직
- 우선순위
  - 보안 위험도가 높은 프로세스(Warning 개수 기준 내림차순)를 최상단에 배치

- 데이터 가공
  - * CPU 사용률은 논리적 최대치인 100%를 초과하지 않도록 제한
  - 네트워크 포트가 5개를 초과할 경우 "n번 포트 외 m건"으로 요약 표시하여 가독성 향상