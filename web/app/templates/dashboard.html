<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Server Monitor</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíæ</text></svg>">
</head>
<body>
<div class="container">

    <h1>SERVER MONITOR</h1>

    <!-- ÏãúÏä§ÌÖú ÏÉÅÌÉú -->
    <div class="container-row">
        <div class="card">
            <p>CPU :
                <span class="{{ cpu_class }}">{{ cpu }}%</span>
            </p>
            <p>MEMORY :
                <span class="{{ memory_class }}">{{ memory }}%</span>
            </p>
            <p>DISK :
                <span class="good">{{ disk }}%</span>
            </p>
            <p>UPTIME :
                <span>{{ uptime }}</span>
            </p>
        </div>

        <!-- ÏÑúÎπÑÏä§ ÏÉÅÌÉú -->
        <div class="card">
            <h2>SERVICES</h2>
            <div class="service-list">
                {% for name, status in services.items() %}
                <div class="service-item">
                    <div class="service-name-group">
                        <span class="dot 
                            {% if 'zombie' in status.lower() or 'idle' in status.lower() %}
                                warn
                            {% elif status.lower().startswith('active') %}
                                on
                            {% else %}
                                off
                            {% endif %}">
                        </span>
                        <span class="service-name">{{ name }}</span>
                    </div>
                    <span class="service-status">[ {{ status | upper }} ]</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Î°úÍ∑∏ ÏΩòÏÜî -->
    <div class="container-row">
        <div class="card log-card">
            <h2>LOG CONSOLE</h2>
            <p style="font-size:9px; color:#999; margin-bottom: 15px;">
                SOURCE : {{ log_source }}
            </p>
            <div class="console" id="log-console">
                {% for line in logs %}<div class="log-line">{{ line }}</div>{% endfor %}
            </div>
        </div>

    <!-- ÌîÑÎ°úÏÑ∏Ïä§ ÏÉÅÌÉú -->
        <div class="card process-card">
            <h2>PROCESSES</h2>

            {% for p in processes %}
            <p class="process-status">
                <!-- ÏÉÅÌÉú ÎèÑÌä∏ -->
                {% if p.status_code == 'OK' %}
                    <span class="dot on"></span>    
                {% elif p.status_code == 'WARN' %}
                    <span class="dot warn"></span>  
                {% elif p.status_code == 'DANGER' %}
                    <span class="dot off"></span>   
                {% else %}
                    <span class="dot"></span>       
                {% endif %}
                
                {{ p.name }} (PID {{ p.pid }})
            </p>

            <p class="process-explain">
                {{ p.explain }}

                {% if not p.is_system %}
                <button class="kill-btn"
                        data-pid="{{ p.pid }}"
                        data-name="{{ p.name }}"
                        onclick="terminateProcess(this)">
                    TERMINATE
                </button>
                {% else %}
                <span style="font-size:10px; color:#666;">
                    SYSTEM PROTECTED
                </span>
                {% endif %}
            </p>

            <p class="process-p">
                CPU : {{ p.cpu }}% |
                MEM : {{ p.memory }}% |
                USER : {{ p.user }}
            </p>

            {% if p.display_ports %}
            <p class="process-p">
                PORT : {{ p.display_ports }}
            </p>
            {% endif %}
            <span style="font-size: 10px; margin-left: 5px;">
                {{ p.status_summary }}
            </span>

            {% if p.warnings %}
                <p class="bad warning-text">
                    {% for warning in p.warnings %}
                        ‚ö† {{ warning }}{% if not loop.last %}<br>{% endif %}
                    {% endfor %}
                </p>
            {% endif %}

            <hr style="border:1px dashed #00ff9c; margin:10px 0;">
            {% endfor %}
        </div>
    </div>
</div>

<div id="custom-modal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <h2 id="modal-title">SYSTEM MESSAGE</h2>
        <p id="modal-message"></p>
        <div class="modal-buttons">
            <button id="modal-cancel-btn" class="kill-btn" style="color: #eee; border-color: #eee;">CANCEL</button>
            <button id="modal-ok-btn" class="kill-btn">CONFIRM</button>
        </div>
    </div>
</div>
</body>

<script>
    const logConsole = document.querySelector('.console');
    logConsole.scrollTop = logConsole.scrollHeight; // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏµúÌïòÎã®ÏúºÎ°ú Ïù¥Îèô

    /**
     * @param {string} title - Ï†úÎ™©
     * @param {string} message - ÎÇ¥Ïö©
     * @param {boolean} showCancel - Ï∑®ÏÜå Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä
     * @param {string} type - 'error', 'success', 'info' (Í∏∞Î≥∏Í∞í: 'error')
     */
    function showModal(title, message, showCancel = false, type = 'error') {
        return new Promise((resolve) => {
            const modal = document.getElementById('custom-modal');
            const card = modal.querySelector('.modal-card');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            // ÌÉÄÏûÖÎ≥Ñ ÏÉâÏÉÅ Ï†ïÏùò
            const colors = {
                error: '#ff5555',   // Îπ®Í∞ï (ÏúÑÌóò, Ïò§Î•ò)
                success: '#00ff9c', // ÌòïÍ¥ë ÎÖπÏÉâ (ÏÑ±Í≥µ, Ï†ïÏÉÅ)
                info: '#ffd866'    // ÎÖ∏Îûë (ÏïåÎ¶º, ÏßÑÌñâ)
            };

            const themeColor = colors[type] || colors.error;

            // Ïä§ÌÉÄÏùº Ï†ÅÏö©
            card.style.borderColor = themeColor;
            titleEl.style.color = themeColor;
            okBtn.style.borderColor = themeColor;
            okBtn.style.color = themeColor;
            
            // OK Î≤ÑÌäº Ìò∏Î≤Ñ Ïãú ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Î∞òÏ†Ñ Ï≤òÎ¶¨Î•º ÏúÑÌïú Ïù∏ÎùºÏù∏ Ïä§ÌÉÄÏùº (CSS Î≥ÄÏàò ÌôúÏö© Í∂åÏû•)
            okBtn.onmouseover = () => { okBtn.style.backgroundColor = themeColor; okBtn.style.color = '#000'; };
            okBtn.onmouseout = () => { okBtn.style.backgroundColor = 'transparent'; okBtn.style.color = themeColor; };

            titleEl.innerText = title;
            messageEl.innerHTML = message;
            modal.style.display = 'flex';

            cancelBtn.style.display = showCancel ? 'inline-block' : 'none';

            okBtn.onclick = () => {
                modal.style.display = 'none';
                resolve(true);
            };

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
                resolve(false);
            };
        });
    }

    async function terminateProcess(button) {
        const pid = button.dataset.pid;
        const name = button.dataset.name;

        const confirmed = await showModal(
            "WARNING: TERMINATE", 
            `[${name}] <br> ÌîÑÎ°úÏÑ∏Ïä§Î•º Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, 
            true, 'error'
        );
        if (!confirmed) return;

        try {
            const response = await fetch("/api/process/terminate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ pid: Number(pid) })
            });
            const data = await response.json();
            
            if (data.result === "terminated") {
                // Ï¢ÖÎ£å ÏÑ±Í≥µ ‚Üí ÌôïÏù∏ ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®
                await showModal("SUCCESS", data.message, false, "success");
                location.reload(); 
            } else {
                // Ï∞®Îã® / Ïã§Ìå® ‚Üí Î©îÏãúÏßÄÎßå ÌëúÏãú (ÏÉàÎ°úÍ≥†Ïπ® ‚ùå)
                await showModal("BLOCKED", data.message, false, "info");
            }
        } catch (error) {
            await showModal("CRITICAL ERROR", "ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", false, "error");
        }
    }
</script>
</html>
